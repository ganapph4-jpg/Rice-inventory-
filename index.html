<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rice Inventory Management System</title>
  <meta name="description" content="A simple, offline-first system for managing rice sales, inventory, and profit tracking.">
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/localforage/dist/localforage.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-dayjs-3@latest/dist/chartjs-adapter-dayjs-3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>


  <style>
    /* Custom CSS Variables for easy theming */
    :root {
      --primary: #3b82f6; /* Blue-500 */
      --secondary: #10b981; /* Green-500 */
      --accent: #f59e0b; /* Amber-500 */
      --light: #f8fafc; /* Slate-50 */
      --dark: #1e293b; /* Slate-800 */
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background-color: var(--light); 
      color: #334155; /* Slate-700 */
      margin: 0;
    }
    
    /* View Transition Styling */
    .main-view { 
      display: none; 
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .main-view.active { 
      display: block; 
    }

    /* --- Modern & Professional Table Styling --- */
    .professional-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 14px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .professional-table thead tr {
        background-color: #f8fafc; /* Slate-50 */
        color: #334155; /* Slate-700 */
        text-align: center;
        font-weight: 600;
        border-bottom: 2px solid #e2e8f0; /* Slate-200 */
    }
    
    .professional-table thead th {
        position: sticky;
        top: 0;
        z-index: 20;
        background-color: #f8fafc; /* Must have a background to hide scrolling content */
    }

    .professional-table th,
    .professional-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .professional-table td:not(:first-child),
    .professional-table th:not(:first-child) {
        text-align: right;
    }

    .professional-table td:first-child,
    .professional-table th:first-child {
        text-align: left;
    }

    .professional-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* --- Modern Category Header Styling --- */
    .category-header td {
        font-size: 1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #fff;
        border: none;
        text-align: left;
        padding-left: 1.5rem;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }
    
    .category-header-25-KG { background-color: #3b82f6; }
    .category-header-10-KG { background-color: #10b981; }
    .category-header-5-KG { background-color: #8b5cf6; }
    .category-header-Per-Kilo { background-color: #f59e0b; }

    /* --- NEW: Repeated Header Row Styling --- */
    .repeated-header {
        background-color: #f8fafc; /* Slate-50 */
        font-weight: 600;
    }
    .repeated-header td {
        padding: 12px 15px !important;
        border-bottom: 2px solid #e2e8f0 !important;
        color: #334155;
        text-align: center;
    }
    .repeated-header td:not(:first-child) {
        text-align: right !important;
    }
    .repeated-header td:first-child {
        text-align: left !important;
    }


    /* --- Footer Row Styling --- */
    .category-total-row {
        font-weight: 700;
        background-color: #f1f5f9;
    }
    .grand-total-row {
        font-size: 1.125rem;
        font-weight: 700;
        background-color: #1e293b;
        color: #fff;
        position: sticky;
        bottom: 0;
        z-index: 10;
    }
    .grand-total-row td {
        border-bottom: none;
    }

    /* Input Styling */
    input[type="number"], input[type="text"], input[type="password"], input[type="date"], select { 
      width: 100%; 
      padding: 6px; 
      font-size: 13px; 
      box-sizing: border-box; 
      border-radius: 4px; 
      border: 1px solid #cbd5e1;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="date"]:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    input.invalid {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
    }
    input:disabled { 
      background-color: #f8fafc;
      color: #64748b;
      border: 1px solid #e2e8f0;
      cursor: not-allowed; 
    }
    
    .loader { 
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary); 
      border-radius: 50%; 
      width: 30px; 
      height: 30px; 
      animation: spin 1s linear infinite; 
      margin: 0 auto; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    #settings-panel { 
      transition: transform 0.3s ease-in-out; 
      transform: translateX(100%);
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    }
    #settings-panel.open { 
      transform: translateX(0); 
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    
    .nav-tab {
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
    }
    .nav-tab.active {
      background-color: var(--primary);
      color: white;
    }
    
    .settings-tab {
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
      border: 1px solid #e2e8f0;
      background-color: #f8fafc;
      color: #475569;
    }
    .settings-tab:hover {
      background-color: #e2e8f0;
      color: #1e293b;
    }
    .settings-tab.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .analytics-tab {
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
        user-select: none;
        border: 1px solid #e2e8f0;
        background-color: #f8fafc;
        color: #475569;
    }
    .analytics-tab:hover {
        background-color: #e2e8f0;
        color: #1e293b;
    }
    .analytics-tab.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: background-color 0.2s;
      border: none;
      cursor: pointer;
    }
    .btn-primary:hover {
      background-color: #2563eb;
    }
    .btn-success {
      background-color: var(--secondary);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: background-color 0.2s;
      border: none;
      cursor: pointer;
    }
    .btn-success:hover {
      background-color: #059669;
    }
    
    .stat-card {
      padding: 20px;
      border-left: 4px solid;
    }
    .category-25 { border-left-color: #3b82f6; }
    .category-10 { border-left-color: #10b981; }
    .category-5 { border-left-color: #8b5cf6; }
    .category-kg { border-left-color: #f59e0b; }

    .small-edit-btn {
        background-color: #64748b;
        color: white;
        padding: 2px 8px;
        font-size: 0.7rem;
        border-radius: 4px;
        transition: background-color 0.2s ease-in-out;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    .small-edit-btn:hover {
        background-color: #475569;
    }
    
    .row-has-sales { background-color: #f0fdf4; }
    .row-has-sales:hover { background-color: #dcfce7; }

    .row-low-stock {
        background-color: #fff1f2 !important;
        border-left: 4px solid #f43f5e;
    }
    .row-low-stock:hover { background-color: #ffe4e6 !important; }

    .row-negative-stock {
        background-color: #fecaca !important;
        border-left: 4px solid #dc2626 !important;
        font-weight: 600;
    }
    .row-negative-stock:hover { background-color: #fca5a5 !important; }
    .row-negative-stock input { border-color: #dc2626 !important; }
    
    .active-row {
        background-color: #dbeafe !important;
        outline: 2px solid var(--primary);
        outline-offset: -2px;
    }

    @media (max-width: 768px) {
      .professional-table { font-size: 12px; }
      .professional-table th, .professional-table td { padding: 6px 8px; }
      .card { margin-bottom: 16px; }
      .settings-tab, .analytics-tab {
        flex-grow: 1;
        text-align: center;
      }
    }
  </style>
</head>
<body class="p-4">

  <!-- Shared Header -->
  <div class="max-w-7xl mx-auto mb-6 flex flex-col sm:flex-row justify-between items-center gap-4" role="banner">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Rice Inventory Management</h1>
      <p class="text-sm text-slate-500" id="header-subtitle">Current Working Day</p>
    </div>
    <div class="flex items-center gap-4">
      <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
        <span id="current-date-display" aria-live="polite"></span>
      </div>
      <button onclick="showHistory()" title="Report History" aria-label="View Report History" class="text-slate-600 hover:text-blue-600 p-2 transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
      </button>
      <button onclick="openSettingsWithPassword()" title="Settings" aria-label="Open Settings" class="text-slate-600 hover:text-blue-600 p-2 transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <nav class="max-w-7xl mx-auto mb-6 bg-white rounded-lg p-1 shadow-sm flex" aria-label="Main Navigation">
    <button class="nav-tab active" role="tab" aria-selected="true" aria-controls="dashboard-view" onclick="showView('dashboard-view')">Dashboard</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="daily-report-view" onclick="showCurrentDayReport()">Daily Report</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="repack-view" onclick="showView('repack-view')">Repack Per Kilo</button>
  </nav>

  <!-- VIEW 1: Dashboard -->
  <main id="dashboard-view" class="main-view active max-w-7xl mx-auto" role="main">
      <div id="dashboard-header" class="mb-6">
        <h2 id="dashboard-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
        <p class="text-sm text-slate-500" id="dashboard-date"></p>
      </div>
      <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="col-span-full text-center p-8"><div class="loader" role="status" aria-label="Loading dashboard"></div></div>
      </div>
  </main>


  <!-- VIEW 2: Daily Report / Inventory -->
  <div id="daily-report-view" class="main-view max-w-7xl mx-auto" role="main" aria-labelledby="report-title">
    <div class="mb-6 p-5 bg-white rounded-lg shadow-sm flex flex-wrap justify-between items-center gap-4">
      <div class="flex items-center gap-4">
        <h2 id="report-title" class="text-xl font-bold text-slate-800">Daily Inventory Report</h2>
      </div>
    </div>
    
    <div class="overflow-hidden">
      <div class="overflow-x-auto">
        <table class="professional-table" aria-live="polite" aria-atomic="true">
          <thead>
            <tr>
              <th>PRODUCT</th>
              <th>BEGIN <br><button class="small-edit-btn mt-1" onclick="promptForCategoryThenEdit('begin')" aria-label="Edit all beginning stock">EDIT ALL</button></th>
              <th>NEW STOCK</th>
              <th>ENDING</th>
              <th>SOLD</th>
              <th>PRICE (₱) <br><button class="small-edit-btn mt-1" onclick="promptForCategoryThenEdit('price')" aria-label="Edit all prices">EDIT ALL</button></th>
              <th>TOTAL SALES (₱)</th>
            </tr>
          </thead>
          <tbody id="inventory-tbody">
            <tr><td colspan="7" class="text-center p-4"><div class="loader" role="status" aria-label="Loading inventory report"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- VIEW 3: REPACK PER KILO -->
  <div id="repack-view" class="main-view max-w-4xl mx-auto" role="region" aria-labelledby="repack-title">
    <div class="mb-6 p-5 bg-white rounded-lg shadow-sm">
        <h2 id="repack-title" class="text-2xl font-bold text-slate-800 text-center">Repack Rice for Per Kilo Sales</h2>
        <p class="text-center text-slate-500 mt-1">Transfer stock from a 25 KG sack to its matching Per Kilo product.</p>
    </div>
    <div id="repack-container" class="card p-8" aria-live="polite" aria-atomic="true">
        <p class="text-center text-slate-500 py-4"><div class="loader" role="status" aria-label="Loading repack options"></div></p>
    </div>
  </div>


  <!-- VIEW 5: Report History -->
  <div id="history-view" class="main-view max-w-7xl mx-auto" role="region" aria-labelledby="history-title">
    <div class="mb-6 flex items-center gap-4">
      <h2 id="history-title" class="text-xl font-bold text-slate-700">Report History</h2>
    </div>
    
    <div class="mb-4 flex flex-col sm:flex-row items-center gap-4">
      <input type="text" id="history-search" placeholder="Search reports by date or content..." class="border border-slate-300 rounded-md py-2 px-3 flex-grow" oninput="filterHistory()" aria-label="Search report history">
      <select id="history-sort" class="border border-slate-300 rounded-md py-2 px-3" onchange="filterHistory()" aria-label="Sort report history">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
      </select>
    </div>
    
    <div id="history-list" class="bg-white rounded-lg shadow divide-y" aria-live="polite" aria-atomic="true">
      <div class="p-4 text-center text-slate-500"><div class="loader" role="status" aria-label="Loading reports"></div></div>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div id="settings-panel" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-lg z-50 p-6 overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="settings-title" tabindex="-1">
    <div class="flex justify-between items-center mb-6">
      <h2 id="settings-title" class="text-2xl font-bold text-slate-800">Settings</h2>
      <button onclick="closeSettingsPanel()" class="text-slate-500 hover:text-red-500 text-3xl transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" aria-label="Close settings panel">&times;</button>
    </div>
    
    <div class="mb-6 flex flex-wrap gap-2" role="tablist">
      <button id="tab-product-management" class="settings-tab active" role="tab" aria-selected="true" aria-controls="settings-product-management-content" onclick="showSettingsTab('settings-product-management-content')">Product Management</button>
      <button id="tab-security" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-security-content" onclick="showSettingsTab('settings-security-content')">Security</button>
      <button id="tab-analytics" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-analytics-content" onclick="showSettingsTab('settings-analytics-content')">Analytics</button>
      <button id="tab-data-management" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-data-management-content" onclick="showSettingsTab('settings-data-management-content')">Data Management</button>
    </div>

    <!-- Settings Content Sections -->
    <div id="settings-product-management-content" class="settings-tab-content" role="tabpanel" aria-labelledby="tab-product-management">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 sr-only">Product Management</h3>
        <div id="product-list-container" class="space-y-2 mb-4 max-h-64 overflow-y-auto border p-2 rounded bg-slate-50" aria-live="polite" aria-atomic="true">
          <p class="text-center text-slate-500">No products added yet.</p>
        </div>
        
        <div class="p-3 bg-slate-50 rounded border">
          <h4 id="product-form-title" class="font-semibold mb-2">Add New Product</h4>
          <input type="hidden" id="product-id">
          <div class="space-y-3">
            <div>
              <label for="product-name" class="block text-sm font-medium text-slate-700 mb-1">Product Name</label>
              <input id="product-name" type="text" placeholder="e.g., Kylo" class="border border-slate-300 p-2 w-full rounded-md" aria-required="true">
            </div>
            <div>
              <label for="product-price" class="block text-sm font-medium text-slate-700 mb-1">Selling Price (₱)</label>
              <input id="product-price" type="number" step="0.01" placeholder="e.g., 1300.00" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this)" aria-required="true">
            </div>
            <div>
              <label for="product-cost" class="block text-sm font-medium text-slate-700 mb-1">Cost Price / Capital (₱)</label>
              <input id="product-cost" type="number" step="0.01" placeholder="e.g., 1150.00" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this)" aria-required="true">
            </div>
            <div>
              <label for="product-minstock" class="block text-sm font-medium text-slate-700 mb-1">Minimum Stock Level</label>
              <input id="product-minstock" type="number" placeholder="e.g., 5" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this, true)" aria-required="true">
            </div>
            <div>
              <label for="product-category" class="block text-sm font-medium text-slate-700 mb-1">Category</label>
              <select id="product-category" class="border border-slate-300 p-2 w-full rounded-md" aria-required="true">
                <option value="25 KG">25 KG</option>
                <option value="10 KG">10 KG</option>
                <option value="5 KG">5 KG</option>
                <option value="Per Kilo">Per Kilo</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button onclick="saveProduct()" class="btn-success flex-1">Save Product</button>
              <button onclick="clearProductForm()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md flex-1 hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="settings-security-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-security">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 sr-only">Security</h3>
        <div class="space-y-3">
          <div>
            <label for="currentPassword" class="block text-sm font-medium text-slate-700 mb-1">Current Password</label>
            <input id="currentPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="current-password">
          </div>
          <div>
            <label for="newPassword" class="block text-sm font-medium text-slate-700 mb-1">New Password</label>
            <input id="newPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="new-password">
          </div>
          <div>
            <label for="confirmPassword" class="block text-sm font-medium text-slate-700 mb-1">Confirm New Password</label>
            <input id="confirmPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="new-password">
          </div>
        </div>
        <button onclick="savePassword()" class="btn-primary w-full mt-4">Change Password</button>
      </div>
    </div>
    
    <!-- Analytics Content (Moved back into settings) -->
    <div id="settings-analytics-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics">
      <div class="mb-6 flex items-center gap-4">
        <h3 class="text-xl font-bold text-slate-700">Sales Analytics</h3>
      </div>

      <!-- Analytics Sub-Tabs -->
      <div class="mb-6 flex flex-wrap gap-2" role="tablist">
        <button id="tab-analytics-overview" class="analytics-tab active" role="tab" aria-selected="true" aria-controls="analytics-overview-content" onclick="showAnalyticsSubTab('analytics-overview-content')">Overview</button>
        <button id="tab-analytics-charts" class="analytics-tab" role="tab" aria-selected="false" aria-controls="analytics-charts-content" onclick="showAnalyticsSubTab('analytics-charts-content')">Charts</button>
        <button id="tab-analytics-products" class="analytics-tab" role="tab" aria-selected="false" aria-controls="analytics-products-content" onclick="showAnalyticsSubTab('analytics-products-content')">Products</button>
      </div>
      
      <!-- Analytics Content: Overview Sub-Tab -->
      <div id="analytics-overview-content" class="analytics-tab-content" role="tabpanel" aria-labelledby="tab-analytics-overview">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Report Options</h4>
            <div class="space-y-3">
              <div>
                <label for="analytics-mode-select" class="block text-sm font-medium text-slate-700 mb-1">Select Report Type</label>
                <select id="analytics-mode-select" class="w-full border border-slate-300 rounded-md py-2 px-3" onchange="toggleAnalyticsDateInputs()">
                  <option value="daily">Daily Breakdown</option>
                  <option value="range">Date Range Report</option>
                </select>
              </div>

              <div id="daily-date-input">
                <label for="analytics-single-date" class="block text-sm font-medium text-slate-700 mb-1">Select Date</label>
                <input type="date" id="analytics-single-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
              </div>

              <div id="range-date-inputs" class="hidden">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="analytics-from-date" class="block text-sm font-medium text-slate-700 mb-1">From Date</label>
                    <input type="date" id="analytics-from-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
                  </div>
                  <div>
                    <label for="analytics-to-date" class="block text-sm font-medium text-slate-700 mb-1">To Date</label>
                    <input type="date" id="analytics-to-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
                  </div>
                </div>
              </div>
            </div>
            <button onclick="loadAnalytics()" class="w-full btn-primary mt-4">Generate Report</button>
          </div>
          
          <div class="card p-6" aria-live="polite" aria-atomic="true">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Summary</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Total Sales</span>
                <span id="analytics-total-sales" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Total Profit</span>
                <span id="analytics-total-profit" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Average Daily Sales</span>
                <span id="analytics-avg-sales" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Average Profit Margin</span>
                <span id="analytics-avg-margin" class="font-semibold">0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="analytics-charts-content" class="analytics-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics-charts">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Sales by Category</h4>
            <canvas id="categoryChart" height="250" role="img" aria-label="Sales by Category Chart"></canvas>
          </div>
          <div class="card p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Daily Sales Trend</h4>
            <canvas id="salesTrendChart" height="250" role="img" aria-label="Daily Sales Trend Chart"></canvas>
          </div>
        </div>
      </div>
      
      <div id="analytics-products-content" class="analytics-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics-products">
        <div class="card p-6">
          <h4 class="text-lg font-bold text-slate-800 mb-4">Top Performing Products</h4>
          <div id="analytics-top-products" class="space-y-3">
            <p class="text-center text-slate-500 py-4">Select a date range to view analytics</p>
          </div>
        </div>
      </div>
    </div>

    <div id="settings-data-management-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-data-management">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 sr-only">Data Management</h3>
        <div class="space-y-3">
          <button onclick="exportAllData()" class="w-full bg-slate-100 text-slate-700 hover:bg-slate-200 py-2 px-4 rounded transition">
            Export All Data
          </button>
          <button onclick="importData()" class="w-full bg-slate-100 text-slate-700 hover:bg-slate-200 py-2 px-4 rounded transition">
            Import Data
          </button>
          <button onclick="resetData()" class="w-full bg-red-100 text-red-700 hover:bg-red-200 py-2 px-4 rounded transition">
            Reset All Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Constants ---
    const RICE_CATEGORIES = ['25 KG', '10 KG', '5 KG', 'Per Kilo'];
    const LOCAL_FORAGE_KEYS = {
        PRODUCTS: 'rice_shop_products',
        REPORTS_PREFIX: 'report_',
        REPORT_INDEX: 'report_index',
        PASSWORD: 'app_password_hash',
        WORKING_DATE: 'current_working_date'
    };
    const HASH_SALT = 'rice-inventory-management-salt'; 
    
    dayjs.extend(dayjs_plugin_isBetween);

    const Toast = Swal.mixin({ 
        toast: true, 
        position: 'top-end', 
        showConfirmButton: false, 
        timer: 3000, 
        timerProgressBar: true 
    });

    // Global variables
    let shopProducts = [];
    let todayDateString;
    let categoryChartInstance = null;
    let salesTrendChartInstance = null;
    let currentDailyReportCategory = null; 
    let calculationTimeout;

    // --- Utility Functions ---
    async function initializeApp() {
        let workingDate = await localforage.getItem(LOCAL_FORAGE_KEYS.WORKING_DATE);
        if (!workingDate || !dayjs(workingDate).isValid()) {
            workingDate = dayjs().format('YYYY-MM-DD');
            await localforage.setItem(LOCAL_FORAGE_KEYS.WORKING_DATE, workingDate);
        }
        todayDateString = workingDate;
        
        document.getElementById('current-date-display').textContent = dayjs(todayDateString).format('MMMM D, YYYY');
        document.getElementById('header-subtitle').textContent = `Current Working Day`;

        await loadProducts(); 
        renderProductList(); 

        document.getElementById('analytics-single-date').value = todayDateString;
        document.getElementById('analytics-from-date').value = dayjs(todayDateString).subtract(7, 'day').format('YYYY-MM-DD');
        document.getElementById('analytics-to-date').value = todayDateString;
        toggleAnalyticsDateInputs(); 

        showView('dashboard-view');
    }

    function validateNumberInput(inputElement, allowZero = false) {
        if (inputElement.value.trim() === '') {
            inputElement.classList.remove('invalid');
            return true;
        }
        const value = parseFloat(inputElement.value);
        if (isNaN(value) || value < 0 || (!allowZero && value === 0)) {
            inputElement.classList.add('invalid');
            return false;
        } else {
            inputElement.classList.remove('invalid');
            return true;
        }
    }

    function formatCurrency(amount) {
        return parseFloat(amount).toFixed(2);
    }
    
    function hashPassword(password) {
        return CryptoJS.SHA256(password + HASH_SALT).toString();
    }

    // --- Data Management Functions ---
    async function loadProducts() {
        let savedProducts = await localforage.getItem(LOCAL_FORAGE_KEYS.PRODUCTS);
        if (!savedProducts || savedProducts.length === 0) {
            savedProducts = [ 
                {id: 'prod_1', name: 'KYLO', price: 1300, cost: 1150, category: '25 KG', minStock: 5}, 
                {id: 'prod_2', name: 'HASMIN AROMA', price: 1350, cost: 1200, category: '25 KG', minStock: 5}, 
                {id: 'prod_3', name: 'ALAS', price: 1250, cost: 1100, category: '25 KG', minStock: 5}, 
                {id: 'prod_4', name: 'YOUNG MASTER', price: 1280, cost: 1130, category: '25 KG', minStock: 5}, 
                {id: 'prod_5', name: 'BLUE HARVEST', price: 1320, cost: 1170, category: '25 KG', minStock: 5}, 
                {id: 'prod_6', name: 'PRINCESS BEA', price: 1270, cost: 1120, category: '25 KG', minStock: 5}, 
                {id: 'prod_7', name: 'ALAS', price: 550, cost: 480, category: '10 KG', minStock: 10}, 
                {id: 'prod_8', name: 'HASMIN AROMA', price: 580, cost: 510, category: '10 KG', minStock: 10}, 
                {id: 'prod_9', name: 'BLUE HARVEST', price: 570, cost: 500, category: '10 KG', minStock: 10}, 
                {id: 'prod_10', name: 'YOUNG MASTER', price: 560, cost: 490, category: '10 KG', minStock: 10}, 
                {id: 'prod_11', name: 'PRINCESS BEA', price: 540, cost: 470, category: '10 KG', minStock: 10}, 
                {id: 'prod_12', name: 'YOUNG MASTER', price: 280, cost: 240, category: '5 KG', minStock: 15}, 
                {id: 'prod_13', name: 'HASMIN AROMA', price: 290, cost: 250, category: '5 KG', minStock: 15}, 
                {id: 'prod_14', name: 'ALAS', price: 270, cost: 230, category: '5 KG', minStock: 15}, 
                {id: 'prod_15', name: 'BLUE HARVEST', price: 285, cost: 245, category: '5 KG', minStock: 15}, 
                {id: 'prod_16', name: 'PRINCESS BEA', price: 260, cost: 220, category: '5 KG', minStock: 15}, 
                {id: 'prod_17', name: 'KYLO', price: 55, cost: 48, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_18', name: 'HASMIN AROMA', price: 60, cost: 52, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_19', name: 'ALAS', price: 50, cost: 45, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_20', name: 'YOUNG MASTER', price: 53, cost: 46, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_21', name: 'BLUE HARVEST', price: 57, cost: 50, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_22', name: 'PRINCESS BEA', price: 49, cost: 43, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_23', name: 'JAZZY', price: 52, cost: 45, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_24', name: 'BIGANTE', price: 48, cost: 41, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_25', name: 'FARNALIZA', price: 51, cost: 44, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_26', name: 'PILIT', price: 47, cost: 40, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_27', name: 'BH YELLOW', price: 54, cost: 47, category: 'Per Kilo', minStock: 20}, 
                {id: 'prod_28', name: 'SWEET RICE', price: 65, cost: 58, category: 'Per Kilo', minStock: 20} 
            ];
            await localforage.setItem(LOCAL_FORAGE_KEYS.PRODUCTS, savedProducts);
        } else {
            savedProducts = savedProducts.map(p => ({ ...p, minStock: p.minStock !== undefined ? p.minStock : 0 }));
            await localforage.setItem(LOCAL_FORAGE_KEYS.PRODUCTS, savedProducts);
        }
        shopProducts = savedProducts;
    }

    async function startDay(dateString) {
        let report = await localforage.getItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${dateString}`);
        if (report) return report;

        const reportIndex = (await localforage.getItem(LOCAL_FORAGE_KEYS.REPORT_INDEX) || []).sort().reverse();
        const lastReportDate = reportIndex.length > 0 ? reportIndex[0] : null;
        const lastReport = lastReportDate ? await localforage.getItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${lastReportDate}`) : null;
        
        const newReportData = {};
        shopProducts.forEach(p => {
            const lastEndStock = lastReport?.data[p.id]?.end || 0;
            newReportData[p.id] = { begin: lastEndStock, newStock: 0, end: lastEndStock, price: p.price, cost: p.cost };
        });

        report = { date: dateString, data: newReportData };
        await localforage.setItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${dateString}`, report);
        Toast.fire({ icon: 'success', title: `Report for ${dayjs(dateString).format('MMM D')} Started!` });
        return report;
    }

    async function saveInventoryData(dateString, productId, data) {
        const report = await localforage.getItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${dateString}`);
        if (report) {
            if (!report.data[productId]) {
                 const productInfo = shopProducts.find(p => p.id === productId);
                 if (productInfo) {
                    report.data[productId] = { begin: 0, newStock: 0, end: 0, price: productInfo.price, cost: productInfo.cost };
                 } else { return; }
            }
            Object.assign(report.data[productId], data);
            await localforage.setItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${dateString}`, report);
        }
    }

    async function finalizeReport() {
        const submittedDate = todayDateString;
        const report = await localforage.getItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${submittedDate}`);
        if (!report) {
            Toast.fire({ icon: 'error', title: "No report to submit." });
            return;
        }
        
        await localforage.setItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${submittedDate}`, report);
        
        let reportIndex = await localforage.getItem(LOCAL_FORAGE_KEYS.REPORT_INDEX) || [];
        if (!reportIndex.includes(submittedDate)) {
            reportIndex.push(submittedDate);
            await localforage.setItem(LOCAL_FORAGE_KEYS.REPORT_INDEX, reportIndex);
        }

        const tomorrowDateString = dayjs(submittedDate).add(1, 'day').format('YYYY-MM-DD');
        const newTomorrowData = {};
        shopProducts.forEach(p => {
            const todayEndStock = report.data[p.id]?.end || 0;
            newTomorrowData[p.id] = {
                begin: todayEndStock,
                newStock: 0,
                end: todayEndStock,
                price: p.price,
                cost: p.cost
            };
        });
        const newTomorrowReport = { date: tomorrowDateString, data: newTomorrowData };
        await localforage.setItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${tomorrowDateString}`, newTomorrowReport);
        
        await localforage.setItem(LOCAL_FORAGE_KEYS.WORKING_DATE, tomorrowDateString);

        await Swal.fire({
            title: 'Report Saved!',
            text: `Today's data is saved. The app will now advance to the next day.`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
        
        location.reload();
    }

    // --- UI Rendering Functions ---
    function updateNavTabs(activeTabId) {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.toggle('active', tab.getAttribute('aria-controls') === activeTabId);
            tab.setAttribute('aria-selected', tab.getAttribute('aria-controls') === activeTabId);
        });
    }

    function showView(viewId) {
        document.querySelectorAll('.main-view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        updateNavTabs(viewId);

        if (viewId === 'repack-view') renderRepackView();
        if (viewId === 'dashboard-view') renderDashboard();
    }
    
    function showCurrentDayReport() {
        showInventory(null, todayDateString);
    }
    
    async function showInventory(category = null, dateString) {
        currentDailyReportCategory = category;
        showView('daily-report-view');
        
        let report = await localforage.getItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${dateString}`);
        if (!report && dateString === todayDateString) {
            report = await startDay(dateString);
        }
        
        renderInventoryTable(category, dateString);
    }

    async function getDailySummary(dateString) {
        const report = await localforage.getItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${dateString}`);
        let totalSales = 0, totalProfit = 0;

        if (report?.data) {
            for (const productId in report.data) {
                const product = shopProducts.find(p => p.id === productId);
                if (!product) continue;

                const item = report.data[productId];
                const sold = (item.begin + item.newStock) - item.end;
                const sales = Math.max(0, sold) * item.price;
                const profit = sales - (Math.max(0, sold) * item.cost);
                totalSales += sales;
                totalProfit += profit;
            }
        }
        return { totalSales, totalProfit };
    }

    async function renderInventoryTable(category, dateString) {
        const inventoryTbody = document.getElementById('inventory-tbody');
        inventoryTbody.innerHTML = '<tr><td colspan="7" class="text-center p-4"><div class="loader" role="status"></div></td></tr>';

        const report = await localforage.getItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${dateString}`);
        if (!report) {
            inventoryTbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-red-600">Report for ${dayjs(dateString).format('MMMM D, YYYY')} not found!</td></tr>`;
            return;
        }
        
        const isEditable = (dateString === todayDateString);
        document.getElementById('report-title').textContent = `Daily Report - ${dayjs(dateString).format('MMMM D, YYYY')}`;
        
        const productsToRender = category 
            ? shopProducts.filter(p => p.category === category) 
            : shopProducts.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));
        
        if (productsToRender.length === 0) {
            inventoryTbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-slate-500">No products found. Add products in settings.</td></tr>`;
            return;
        }
        
        let tableHtml = '', footerHtml = '';
        const groupedProducts = {};
        const categoriesToLoop = category ? [category] : RICE_CATEGORIES;
        categoriesToLoop.forEach(cat => groupedProducts[cat] = []);
        productsToRender.forEach(p => {
             if (groupedProducts[p.category]) groupedProducts[p.category].push(p);
        });

        let overallTotalSold = 0, overallTotalSales = 0;
        let hasProductsInAnyCategory = false; 
        let isFirstCategory = true;
        
        const repeatedHeaderHtml = `
            <tr class="repeated-header">
                <td class="repeated-header-cell">PRODUCT</td>
                <td class="repeated-header-cell">BEGIN</td>
                <td class="repeated-header-cell">NEW STOCK</td>
                <td class="repeated-header-cell">ENDING</td>
                <td class="repeated-header-cell">SOLD</td>
                <td class="repeated-header-cell">PRICE (₱)</td>
                <td class="repeated-header-cell">TOTAL SALES (₱)</td>
            </tr>`;

        categoriesToLoop.forEach(cat => {
            const productsInCategory = groupedProducts[cat].sort((a, b) => a.name.localeCompare(b.name));
            if (productsInCategory.length > 0) {
                hasProductsInAnyCategory = true;
                
                if (!category) {
                    const cleanCatClass = cat.replace(/\s+/g, '-');
                    tableHtml += `<tr class="category-header category-header-${cleanCatClass}"><td colspan="7">${cat}</td></tr>`;
                    if (!isFirstCategory) tableHtml += repeatedHeaderHtml; // Add repeated header
                    isFirstCategory = false;
                }

                let categoryTotalSold = 0, categoryTotalSales = 0;

                productsInCategory.forEach(product => {
                    const data = report.data[product.id] || { begin: 0, newStock: 0, end: 0, price: product.price, cost: product.cost };
                    const sold = (data.begin + data.newStock) - data.end;
                    const totalSales = Math.max(0, sold) * data.price;
                    categoryTotalSold += sold;
                    categoryTotalSales += totalSales;
                    
                    const rowClasses = [];
                    if (sold > 0) rowClasses.push('row-has-sales');
                    if (data.end < 0) rowClasses.push('row-negative-stock');
                    else if (product.minStock > 0 && data.end <= product.minStock) rowClasses.push('row-low-stock');

                    tableHtml += `<tr data-id="${product.id}" class="${rowClasses.join(' ')}">
                        <td class="font-medium">${product.name}</td>
                        <td><input type="number" value="${data.begin}" class="begin-val" disabled /></td>
                        <td><input type="number" value="${data.newStock}" class="new-stock-input" ${!isEditable ? 'disabled' : ''} oninput="validateNumberInput(this, true); debouncedCalculate(this, '${dateString}');"/></td>
                        <td><input type="number" value="${data.end}" class="end-input" ${!isEditable ? 'disabled' : ''} oninput="validateNumberInput(this, true); debouncedCalculate(this, '${dateString}');"/></td>
                        <td><input type="number" value="${sold}" class="sold-val" disabled /></td>
                        <td><input type="number" step="0.01" value="${formatCurrency(data.price)}" class="price-val" disabled /></td>
                        <td class="total-sales-val font-bold" aria-live="polite">${formatCurrency(totalSales)}</td>
                    </tr>`;
                });

                const cleanCat = cat.replace(' ', '-');
                tableHtml += `
                <tr class="category-total-row">
                    <td colspan="4" class="text-right p-3">Total for ${cat}</td>
                    <td id="category-total-sold-${cleanCat}" class="p-3">${categoryTotalSold}</td>
                    <td></td>
                    <td id="category-total-sales-${cleanCat}" class="p-3">₱${formatCurrency(categoryTotalSales)}</td>
                </tr>`;
                
                overallTotalSold += categoryTotalSold;
                overallTotalSales += categoryTotalSales;
            }
        });

        if (!hasProductsInAnyCategory) {
            inventoryTbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-slate-500">No products found.</td></tr>`;
            return;
        }

        if (!category && hasProductsInAnyCategory) {
             footerHtml += `<tr class="grand-total-row">
                <td colspan="4" class="text-right p-4">OVERALL GRAND TOTAL</td>
                <td id="overall-total-sold" class="p-4">${overallTotalSold}</td>
                <td></td>
                <td id="overall-total-sales" class="p-4">₱${formatCurrency(overallTotalSales)}</td>
             </tr>`;
        }

        if (isEditable) {
            footerHtml += `<tr><td colspan="7" class="p-4 bg-white"><div class="flex justify-center"><button onclick="showReviewModal()" class="btn-success">Save Today & Start Next Day</button></div></td></tr>`;
        } else {
            footerHtml += `<tr><td colspan="7" class="p-4 bg-slate-50 text-center"><p class="font-medium text-slate-600">Viewing a past report. Click the Daily Report tab for the current day.</p></td></tr>`;
        }

        inventoryTbody.innerHTML = tableHtml + footerHtml;
    }

    function updateInventoryTableTotals() {
        const categories = {};
        RICE_CATEGORIES.forEach(cat => categories[cat] = { sold: 0, sales: 0 });
        let overallSold = 0, overallSales = 0;

        document.querySelectorAll('#inventory-tbody tr[data-id]').forEach(row => {
            const productId = row.dataset.id;
            const product = shopProducts.find(p => p.id === productId);
            if (!product) return;

            const sold = parseInt(row.querySelector('.sold-val').value) || 0;
            const sales = parseFloat(row.querySelector('.total-sales-val').textContent.replace(/[₱,]/g, '')) || 0;

            if (categories[product.category]) {
                categories[product.category].sold += sold;
                categories[product.category].sales += sales;
            }
            overallSold += sold;
            overallSales += sales;
        });

        for (const cat in categories) {
            const cleanCat = cat.replace(' ', '-');
            const soldEl = document.getElementById(`category-total-sold-${cleanCat}`);
            const salesEl = document.getElementById(`category-total-sales-${cleanCat}`);
            if (soldEl) soldEl.textContent = categories[cat].sold;
            if (salesEl) salesEl.textContent = `₱${formatCurrency(categories[cat].sales)}`;
        }

        const overallSoldEl = document.getElementById('overall-total-sold');
        const overallSalesEl = document.getElementById('overall-total-sales');
        if (overallSoldEl) overallSoldEl.textContent = overallSold;
        if (overallSalesEl) overallSalesEl.textContent = `₱${formatCurrency(overallSales)}`;
    }

    async function calculate(inputElement, dateString) {
        if (inputElement.classList.contains('invalid')) return;

        const row = inputElement.closest('tr');
        if (!row || !row.dataset.id) return;

        const productId = row.dataset.id;
        const report = await localforage.getItem(`${LOCAL_FORAGE_KEYS.REPORTS_PREFIX}${dateString}`);
        if (!report) return;

        const data = report.data[productId];
        if (!data) return;

        const begin = parseFloat(row.querySelector('.begin-val').value) || 0;
        const newStock = parseFloat(row.querySelector('.new-stock-input').value) || 0;
        const end = parseFloat(row.querySelector('.end-input').value) || 0;
        
        const sold = (begin + newStock) - end;
        row.querySelector('.sold-val').value = sold;
        row.querySelector('.total-sales-val').textContent = formatCurrency(Math.max(0, sold) * data.price);
